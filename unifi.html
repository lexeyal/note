
скрипт для чистки
http://rootstore.ru/texinfo/unifi-kak-udalit-starye-lishnie-dannye-i-otregulirovat-razmer-bazy-dannyx-mongo/


Как удалить старые данные из контроллера, функционирующего под управлением Linux (Ubuntu, Debian и облачный ключ (Cloud Key))

Подготовительные действия: Перед выполнением сценария, контроллер должен уже работать.  Если он не работает, пожалуйста, запустите его и только потом выполните описанные ниже шаги.  Вы можете запустить контроллер, введя после выполнения шага 2 следующую команду:

sudo service unifi start

Перед внесением значительных изменений (подобных этому) не забывайте создать резервную копию контроллера.

Шаг 1: Установление соединения

Подключитесь к серверу по SSH, используя клиент, который предпочитаете и пройдите аутентификацию.  Снимки экрана в этом разделе статьи сделаны для приложения PuTTY (в Windows).  Если используется клиент Linux или Mac, Вы можете подключиться к серверу из встроенного терминала.

Шаг 2: Вход в рабочий каталог

Перейдите в Ваш домашний каталог, либо создайте рабочий каталог (по своему усмотрению).  При напрсании данной статьи был использован домашний каталог.

cd ~

Шаг 3: Загрузка сценария

Загрузите на свой сервер сценарий для удаления старых данных:

wget https://help.ubnt.com/hc/en-us/article_attachments/204082688/mongo_prune_js.js

2.68-7

Шаг 4: Выполнение теста работоспособности

Выполните тест работоспособности сценария.  По умолчанию сценарий работает в пробном режиме «dryrun». Поэтому он будет сообщать, что он удалит старые данные из базы данных, но на самом деле этого происходить не будет.  На этом шаге убедитесь, что сценарий действительно работает так, как ожидается.

mongo —port 27117 < mongo_prune_js.js

На выходе должно быть примерно следующее:

2.68-8

Шаг 5: Выключение пробного режима «dryrun»
Чтобы выключить режим dryrun и задать число дней поддержки данных, отредактируйте сценарий.  По умолчанию сценарий поддерживает данные 7 дней.  Для редактирования сценария используйте редактор nano или ему подобный:

nano mongo_prune_js.js

Допустим, Вы используете редактор nano. Для навигации по тексту используйте кнопки со стрелками.  Отредактируйте var days=7; задайте другое число дней поддержки данных; измените var dryrun=true; на var dryrun=false; это позволит сценарию действительно удалять старые данные из базы данных (то есть он будет работать не так, как в режиме тестирования).  По завершении редактирования, нажмите на клавиатуре CTRL + O, чтобы сохранить файл (для подтверждения нажмите Enter). Затем нажмите CTRL + X, чтобы выйти из редактора.

2.68-9

Примечание: Если выдается ошибка, уведомляющая, что редактор nano не установлен, Вы можете установить его, выполнив следующую команду (после нее снова введите предыдущую команду):

sudo apt-get update && sudo apt-get -y install nano

Шаг 6: Удаление старых данных из базы данных

Запустите отредактированный сценарий, реально вычищающий старые данные из базы данных:

mongo —port 27117 < mongo_prune_js.js

Примечание: Вследствие того, что база данных действительно изменяется, данный шаг может занять больше времени, чем в режиме тестирования на шаге 4.  Не прерывайте вывод на консоли до тех пор, пока не получите сообщение «bye».

Шаг 7: Проверка выполнения

Убедитесь, что операция завершилась успешно и что не было сообщений об ошибках. На выходе должно быть примерно следующее:

2.68-10

Шаг 8 (ОПЦИЯ): Чистка

Удалите сценарий из Вашего домашнего каталога, если не намереваетесь использовать его снова.

rm mongo_prune_js.js

Шаг 9: Завершение сессии

Завершите сессию терминала:

exit

